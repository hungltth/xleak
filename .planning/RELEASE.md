# **Migration Plan: Consolidating Release Workflows for xleak**

**Goal:** Replace fragmented CI workflows with a unified "Holy Trinity" pipeline:

1. **cargo-release:** Triggers version bumps, tagging, and changelog updates.  
2. **cargo-dist:** Builds binaries, creates releases, and pushes to Homebrew/Scoop (via CI).  
3. **cargo-aur:** Generates Arch Linux packages (manual post-release step).

## **ðŸ› ï¸ Phase 1: Preparation (One-Time Setup)**

### **1\. Install Tooling**

Ensure you have the required CLI tools installed locally:

cargo install cargo-dist cargo-release cargo-aur

### **2\. Create the Homebrew Tap**

You need a centralized repository for all your Homebrew formulas.

1. Create a new **public** repository on GitHub named: bgreenwell/homebrew-tap  
2. Initialize it with the required structure:  
   git clone \[https://github.com/bgreenwell/homebrew-tap.git\](https://github.com/bgreenwell/homebrew-tap.git)  
   cd homebrew-tap  
   mkdir Formula  
   touch Formula/.keep  
   \# (Optional) Create a README.md using the template below  
   git add .  
   git commit \-m "Initialize tap structure"  
   git push

### **3\. (Optional) Create Scoop Bucket**

If you want to support Windows Scoop users:

1. Create a public repo named: bgreenwell/scoop-bucket.  
2. It can be empty or contain just a README.

## **ðŸ§¹ Phase 2: Cleanup xleak Repository**

Remove the old, conflicting workflows from your xleak repository to prevent double-publishing or errors.

**Delete these files:**

* .github/workflows/create-release.yml (or similar release workflow)  
* .github/workflows/update-homebrew.yml

**Keep:**

* .github/workflows/ci.yml (PR checks/tests should remain separate).

## **âš™ï¸ Phase 3: Initialize & Configure**

### **1\. Initialize cargo-dist**

Run this command in the xleak project root:

cargo dist init \--installer=shell \--installer=powershell \--installer=homebrew \--installer=scoop

**Interactive Prompts:**

* **CI:** GitHub Actions  
* **Homebrew Tap:** bgreenwell/homebrew-tap  
* **Scoop Bucket:** bgreenwell/scoop-bucket (or skip if not created)  
* **Trigger:** Tag  
* **Binaries:** Select xleak

### **2\. Update Cargo.toml**

Open Cargo.toml and ensure the following sections exist. You will likely need to manually add the \[package.metadata.release\] and \[package.metadata.aur\] blocks.

\# \--- Cargo Dist Config (Generated by init, verify it looks similar to this) \---  
\[workspace.metadata.dist\]  
\# The preferred cargo-dist version to use in CI (Cargo.toml SemVer syntax)  
cargo-dist-version \= "0.14.1" \# (or whichever version you installed)  
\# CI backends to support  
ci \= \["github"\]  
\# The installers to generate for each app  
installers \= \["shell", "powershell", "homebrew", "scoop"\]  
\# Target platforms to build apps for (Rust target-triple syntax)  
targets \= \["aarch64-apple-darwin", "x86\_64-apple-darwin", "x86\_64-unknown-linux-gnu", "x86\_64-pc-windows-msvc"\]  
\# Publish jobs to run in CI  
pr-run-mode \= "plan"  
\# Where to host the Homebrew tap  
tap \= "bgreenwell/homebrew-tap"  
\# Where to host the Scoop bucket  
scoop-bucket \= "bgreenwell/scoop-bucket"

\# \--- Cargo Release Config (Add this manually) \---  
\[package.metadata.release\]  
\# Update the changelog automatically  
pre-release-replacements \= \[  
  {file="CHANGELOG.md", search="\#\# \\\\\[Unreleased\\\\\]", replace="\#\# \[{{version}}\] \- {{date}}"},  
\]  
\# The git tag format  
tag-message \= "Release {{version}}"  
\# Push the tag AND the commit to trigger CI  
push-options \= \["--follow-tags"\]  
\# Don't publish to crates.io (set to true if you DO want to publish to crates.io)  
publish \= false

\# \--- Cargo AUR Config (Add this manually) \---  
\[package.metadata.aur\]  
\# This points AUR users to the binary built by GitHub Actions  
\# Note: Ensure the artifact name matches what cargo-dist produces.  
\# standard cargo-dist format is: {name}-v{version}-{target}.tar.gz or similar.  
\# cargo-aur usually defaults to looking for source tarballs, so we force it to look for the bin.  
source \= "\[https://github.com/bgreenwell/xleak/releases/download/v\](https://github.com/bgreenwell/xleak/releases/download/v){version}/{name}-x86\_64-unknown-linux-musl.tar.gz"

\# Optional: List runtime dependencies if you dynamically link  
\# depends \= \["openssl"\]

## **ðŸš€ Phase 4: Execute a Release**

**Important:** Commit and push the configuration changes above *before* running the release command.

### **1\. The Trigger**

When you are ready to ship v0.2.0 (or whatever the next version is), run this **locally**:

\# Bumps version, updates changelog, tags, and pushes to GitHub  
cargo release patch \--execute

### **2\. The Build (Automated)**

* **GitHub Actions** picks up the new tag.  
* **cargo-dist** builds binaries for all platforms.  
* It creates a **GitHub Release**.  
* It commits xleak.rb to bgreenwell/homebrew-tap.  
* It commits xleak.json to bgreenwell/scoop-bucket.

### **3\. The Arch Linux Step (Manual)**

Once the GitHub Release is published and you see the green checkmark in Actions:

\# 1\. Generate the PKGBUILD pointing to the new release URL  
cargo aur

\# 2\. Push to AUR (assuming you have the AUR repo cloned locally)  
cp target/cargo-aur/PKGBUILD ../xleak-aur/  
cd ../xleak-aur  
makepkg \--printsrcinfo \> .SRCINFO  
git add PKGBUILD .SRCINFO  
git commit \-m "Update to v(new\_version)"  
git push
